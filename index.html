<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coinfluence ‚Äî The Social Coin Jar</title>
<!-- Firebase SDK -->
<script type="module" src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>
  <style>
  :root{
    --bg:#0f1720; --card:#111827; --accent:#f9c74f;
    --jar-border: rgba(255,255,255,0.06);
    --success: #10b981;
    --danger: #ef4444;
    --info: #3b82f6;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg,#071021 0%, #0f2436 100%); font-family:Inter,Segoe UI,Arial;
    color:#e6eef8; padding:22px;
  }
  .card{
    width:min(880px,96%); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }
  h1{margin:0 0 12px; font-size:20px; letter-spacing:0.6px}
  .layout{display:flex; gap:18px; align-items:flex-start}
  .left{flex:0 0 380px; display:flex; flex-direction:column; align-items:center}
  .jar-wrap{width:320px; height:360px; position:relative; display:flex; align-items:flex-end; justify-content:center; padding:18px}
  .jar{
    width:260px; height:300px; border-radius:22px 22px 18px 18px; position:relative; overflow:visible;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border: 4px solid var(--jar-border); box-shadow: inset 0 -10px 30px rgba(0,0,0,0.6);
  }
  .jar-mouth{
    position:absolute; top:-18px; left:50%; transform:translateX(-50%); width:170px; height:18px; border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  }
  /* coins container (absolute inside jar) */
  .coins{
    position:absolute; left:50%; transform:translateX(-50%); bottom:8px; width:86%; height:calc(100% - 28px);
    pointer-events:none;
  }

  .coin{
    position:absolute; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    box-shadow: 0 8px 18px rgba(0,0,0,0.6); font-weight:700; font-size:12px;
    background: radial-gradient(circle at 30% 25%, #fff6d6, #f7d97a 30%, #f2b93a 60%);
    border: 2px solid rgba(0,0,0,0.15); color:#3b2a00;
    transform-origin:center;
  }
  /* drop animation */
  @keyframes drop {
    0% { transform: translateY(-160px) rotate(-30deg); opacity:0 }
    60%{ opacity:1}
    100% { transform: translateY(0) rotate(0deg); opacity:1 }
  }
  .dropping{ animation: drop 550ms cubic-bezier(.2,.9,.2,1) forwards; z-index:999 }
  /* flip visual */
  .flip-anim{ animation: coinFlip 700ms ease forwards; }
  @keyframes coinFlip{
    0%{ transform: rotateY(0) translateY(-10px) }
    50%{ transform: rotateY(180deg) translateY(-40px) }
    100%{ transform: rotateY(360deg) translateY(0) }
  }

  .right{flex:1; min-width:240px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px}
  button{
    background:#0b1220; color:#e6eef8; border:1px solid rgba(255,255,255,0.04); padding:10px 14px; border-radius:8px;
    cursor:pointer; font-weight:600;
  }
  button:active{ transform:translateY(1px) }
  .counter{margin-left:auto; background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:8px; font-weight:700}
  .small{font-size:13px; color:#b9c6d6}
  .note{margin-top:10px; font-size:13px; color:#9fb0c6}
  .toast{position:fixed; right:20px; bottom:20px; background:rgba(0,0,0,0.8); padding:12px 18px; border-radius:8px; color:#fff; z-index:1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
  .toast.success{background: var(--success);}
  .toast.error{background: var(--danger);}
  .toast.info{background: var(--info);}
  .leaderboard {background: rgba(255,255,255,0.02); border-radius: 8px; padding: 12px; margin-top: 16px;}
  .leaderboard h3 {margin: 0 0 8px; font-size: 14px; color: #e6eef8;}
  .leaderboard ol {padding-left: 20px; margin: 0;}
  .leaderboard li {margin: 4px 0; font-size: 13px;}
  .leaderboard .highlight {color: var(--accent); font-weight: 600;}
  .progress-bar {height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 8px 0; overflow: hidden;}
  .progress {height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease;}
  .timing-display {text-align: center; font-size: 12px; margin-top: 4px; color: #9fb0c6;}
  .tip-button {background: linear-gradient(135deg, #6b46c1 0%, #8b5cf6 100%) !important; border: none !important;}
  .game-area {position: relative; margin-bottom: 16px;}
  .target-zone {height: 100px; background: rgba(249, 199, 79, 0.1); border: 2px dashed var(--accent); border-radius: 8px; margin: 12px 0; position: relative;}
  .sweet-spot {position: absolute; height: 20px; width: 40px; background: var(--accent); top: 40px; left: 50%; transform: translateX(-50%); border-radius: 4px;}
  .sweet-spot::before {content: 'SWEET SPOT'; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--accent); white-space: nowrap;}
  .coin-cursor {position: absolute; width: 40px; height: 40px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f9c74f"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>') no-repeat center; pointer-events: none; z-index: 100; display: none;}
  @media (max-width:700px){
    .layout{flex-direction:column}
    .left{width:100%}
    .jar-wrap{width:100%; height:320px}
  }
</style>
</head>
<body>
  <div class="card" role="main">
    <h1>Coinfluence ‚Äî The Social Coin Jar</h1>
    <div class="layout">
      <div class="left">
        <div class="jar-wrap">
          <div class="jar" aria-hidden="false" id="jar">
            <div class="jar-mouth"></div>
            <div class="coins" id="coins"></div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <button id="dropBtn">Drop coin</button>
          <button id="flipBtn">Flip 1</button>
          <button id="resetBtn">Reset</button>
          <button id="shareBtn">Share link</button>
          <div class="counter" id="counter">0</div>
        </div>
        <div class="note">Drop coins, stack them, or flip to gamble ‚Äî coins persist in your browser.</div>
      </div>
      <div class="right">
        <div class="game-area">
          <div class="target-zone" id="targetZone">
            <div class="sweet-spot"></div>
          </div>
          <div class="progress-bar">
            <div class="progress" id="flipProgress"></div>
          </div>
          <div class="timing-display" id="timingDisplay">Press SPACE when the bar is in the sweet spot!</div>
        </div>
        
        <div class="controls">
          <button id="dropBtn">Drop Coin (SPACE)</button>
          <button id="flipBtn" disabled>Flip (SPACE)</button>
          <button id="tipBtn" class="tip-button">Tip Jar üí∞</button>
          <div class="counter" id="counter">0</div>
        </div>
        
        <div class="leaderboard">
          <h3>üèÜ Top Players</h3>
          <ol id="leaderboardList">
            <li>Loading leaderboard...</li>
          </ol>
        </div>
        
        <div class="note">
          <strong>How to play:</strong> Press SPACE when the moving bar is in the yellow zone to win coins!
          Compete with others in real-time and support the game with tips.
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const coinsContainer = document.getElementById('coins');
      const dropBtn = document.getElementById('dropBtn');
      const flipBtn = document.getElementById('flipBtn');
      const resetBtn = document.getElementById('resetBtn');
      const counterEl = document.getElementById('counter');
      const shareBtn = document.getElementById('shareBtn');

      // load from URL param if present
      const urlParams = new URLSearchParams(location.search);
      let coins = parseInt(localStorage.getItem('cf_coins') || '0', 10);
      if (urlParams.has('coins')) {
        const v = parseInt(urlParams.get('coins'),10);
        if (!isNaN(v) && v >= 0) coins = v;
      }

      function updateCounter(){
        counterEl.textContent = coins;
      }

      function save(){
        localStorage.setItem('cf_coins', String(coins));
      }

      // render static stack based on current coin count
      function renderStack(){
        coinsContainer.innerHTML = '';
        const maxStack = Math.min(coins, 40);
        for (let i = 0; i < maxStack; i++){
          const coin = document.createElement('div');
          coin.className = 'coin';
          coin.textContent = '';
          // random small horizontal jitter to avoid perfect stack
          const leftPct = 50 + (Math.random()-0.5)*18;
          coin.style.left = leftPct + '%';
          coin.style.bottom = (8 + i * 10) + 'px';
          coin.style.transform = `rotate(${(Math.random()-0.5)*20}deg)`;
          coinsContainer.appendChild(coin);
        }
        // if too many, show a compact badge for remainder
        if (coins > 40){
          const more = document.createElement('div');
          more.className = 'coin';
          more.textContent = '+' + (coins - 40);
          more.style.left = '50%';
          more.style.bottom = (8 + 40 * 10) + 'px';
          more.style.width = '64px';
          more.style.height = '64px';
          more.style.fontSize = '14px';
          coinsContainer.appendChild(more);
        }
        updateCounter();
      }

      // drop animation: create coin with dropping class then settle into stack
      function dropCoin(){
        const limit = 200; // safety cap
        if (coins >= limit) {
          toast('Max coins reached');
          return;
        }
        coins += 1;
        save();
        updateCounter();

        const dropEl = document.createElement('div');
        dropEl.className = 'coin dropping';
        dropEl.style.left = (50 + (Math.random()-0.5)*18) + '%';
        dropEl.style.bottom = '220px';
        dropEl.textContent = '';
        coinsContainer.appendChild(dropEl);

        // when animation ends, reposition it into stack (after 550ms)
        dropEl.addEventListener('animationend', () => {
          // compute index in stack (we'll re-render to keep spacing consistent)
          renderStack();
          // small sparkle
          if (coins === 10) toast('Achievement: 10 coins!', 2500);
        }, { once: true });
      }

      // flip 1 coin: bets 1 coin, wins 2 (net +1) on heads
      function flipOne(){
        if (coins <= 0) { toast('No coins to flip'); return; }
        // temporarily disable flip
        flipBtn.disabled = true;
        // consume 1 coin for the bet (it will be restored if win)
        coins -= 1;
        save();
        updateCounter();

        // create visual flipping coin
        const anim = document.createElement('div');
        anim.className = 'coin flip-anim';
        anim.style.left = '50%';
        anim.style.bottom = '90px';
        anim.style.width = '68px';
        anim.style.height = '68px';
        anim.style.fontSize = '16px';
        anim.textContent = '';
        coinsContainer.appendChild(anim);

        // run random outcome
        const win = Math.random() < 0.5; // fair coin
        setTimeout(() => {
          if (win){
            // award 2 coins (so net +1)
            coins += 2;
            save();
            toast('Heads! You doubled your bet üéâ', 2200);
          } else {
            toast('Tails ‚Äî you lost the bet', 1600);
          }
          renderStack();
          flipBtn.disabled = false;
          // remove anim (let renderStack create static coins)
          anim.remove();
        }, 800);
      }

      function resetAll(){
        if (!confirm('Reset coin count to zero?')) return;
        coins = 0;
        save();
        renderStack();
      }

      function toast(msg, t = 1400){
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), t);
      }

      function shareLink(){
        const u = new URL(location.href);
        u.searchParams.set('coins', String(coins));
        const link = u.toString();
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(link).then(()=> toast('Share link copied!'));
        } else {
          prompt('Copy link:', link);
        }
      }

      // attach handlers
      dropBtn.addEventListener('click', dropCoin);
      flipBtn.addEventListener('click', flipOne);
      resetBtn.addEventListener('click', resetAll);
      shareBtn.addEventListener('click', shareLink);

      // init
      renderStack();
    })();
  </script>
</body>
</html>
